<!doctype html>
<html class="no-js" lang="">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>WebGL Game Of Life</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/main.css">
    <script src="js/vendor/modernizr-2.8.3.min.js"></script>
    <script src="js/three.min.js"></script>
    <script src="js/vendor/jquery-1.11.2.min.js"></script>
</head>

<body>

    <script>
        var scene, camera, renderer;
        var geometry, material, plane, planeHolder;
        var DeadColor, LifeColor;
        var unit = 25;
        var gridWidth = 5,
            gridHeight = 5;
        var raycaster, mouse;
        var active = false;
        var deactive = false;
        var enable = false;
        var fps, fpsInterval, startTime, now, then, elapsed;

        init();
         //frame rate
        startAnimating(2);
        document.onkeydown = inputKey;

        function init() {
            "use strict";

            //Scene
            scene = new THREE.Scene();
            camera = new THREE.OrthographicCamera(-window.innerWidth, window.innerWidth, -window.innerHeight, window.innerHeight, 1, 10000);
            camera.position.z = 100;



            //Color black = dead , white = alive
            DeadColor = new THREE.Color(0, 0, 0);
            LifeColor = new THREE.Color(1, 1, 1);

            //Plane Geometry & Material
            geometry = new THREE.PlaneGeometry(unit * gridWidth, unit * gridHeight, gridWidth, gridHeight);
            material = new THREE.MeshBasicMaterial({
                vertexColors: THREE.FaceColors,
                side: THREE.DoubleSide
            });

            plane = new THREE.Mesh(geometry, material);
            


            renderer = new THREE.WebGLRenderer();
            renderer.setClearColor(new THREE.Color(0xaaaaaa));
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            //Listenners
            document.addEventListener('mousedown', onDocumentMouseDown, false);
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();
            document.addEventListener('mousemove', onDocumentMouseMove, false);

            //Make sure plane is set all to dead
            planeHolder = new THREE.Mesh(geometry.clone(), material.clone());
            for (var i = 0; i < ((gridHeight * gridWidth) * 2); i += 2) {

                SetPairColor(i, DeadColor);
                plane.geometry.faces[i].color.set(DeadColor);
                plane.geometry.faces[SisterIndex(i)].color.set(DeadColor);

            }
            plane.geometry.colorsNeedUpdate = true;
            planeHolder.geometry.colorsNeedUpdate = true;
            scene.add(plane);

        }

        function startAnimating(fps) {
            "use strict";

            fpsInterval = 1000 / fps;
            then = Date.now();
            startTime = then;
            animate();
        }


        function animate() {
            "use strict";
            requestAnimationFrame(animate);
            
            now = Date.now();
            elapsed = now - then;

            if (elapsed > fpsInterval) {

                then = now - (elapsed % fpsInterval);

                if (enable == true) {

                    Simulation();
                    scene.remove(plane);
                    plane = null;
                    plane = planeHolder.clone();
                    planeHolder = new THREE.Mesh(geometry.clone(), material.clone());

                    scene.add(plane);

                    plane.geometry.colorsNeedUpdate = true;
                }

            }

            CastRay();
            renderer.render(scene, camera);

        }



        /* Rules
1.   live cell < 2 live neighbours = dead
2.   live cell with 2 ~ 3 = live 
3.   live cell with 3 or more = die
3.   death cell with 3  = live    
*/
        function Simulation() {
            "use strict";

            for (var i = 0; i < ((gridHeight * gridWidth) * 2); i += 2) {

                var count = GetNeighboursCount(i);

                if ((count < 2) || (count > 3)) {

                    SetPairColor(i, DeadColor);

                } else if (count == 3) {

                    SetPairColor(i, LifeColor);

                }

            }

        }


        function GetNeighboursCount(index) {
            "use strict";

            var count = 0;

            //Left
            //Check if we are at the left
            if (index % (gridWidth * 2) != 0) {

                // SetPairColor(index);
                count += GetCount(index - 2);

            }

            //Right
            //Check if we are at the Right
            if ((index + 2) % (gridHeight * 2) != 0) {

                // SetPairColor(index);
                count += GetCount(index + 2);

            }

            //Top
            //Check if we are at the Top
            if (index < (gridHeight * gridWidth) * 2 - gridWidth * 2) {

                // SetPairColor(index);
                count += GetCount(index + gridWidth * 2);

            }

            //Buttom
            //Check if we are at the Buttom
            if (index > gridWidth * 2 - 1) {

                //  SetPairColor(index);
                count += GetCount(index - gridWidth * 2);
            }

            //TopLeft
            //Check if we are at the TopLeft
            if ((index < (gridHeight * gridWidth) * 2 - gridWidth * 2) && (index % (gridWidth * 2) != 0)) {
                // SetPairColor(index);
                count += GetCount(index + gridWidth * 2 - 2);
            }

            //TopRight
            //Check if we are at the TopRight
            if ((index < (gridHeight * gridWidth) * 2 - gridWidth * 2) && ((index + 2) % (gridHeight * 2) != 0)) {
                //SetPairColor(index);
                count += GetCount(index + gridWidth * 2 + 2);
            }

            //ButtomLeft
            //Check if we are at the ButtomLeft
            if ((index > gridWidth * 2 - 1) && (index % (gridWidth * 2) != 0)) {

                // SetPairColor(index);
                count += GetCount(index - gridWidth * 2 - 2);
            }

            //ButtomRight
            //Check if we are at the ButtomRight
            if ((index > gridWidth * 2 - 1) && ((index + 2) % (gridHeight * 2) != 0)) {

                //SetPairColor(index);
                count += GetCount(index - gridWidth * 2 + 2);
            }

            return count;
        }

        function GetCount(index) {
            "use strict";

            if (plane.geometry.faces[index].color.getHex() == LifeColor.getHex()) {
                return 1;
            }
            return 0;
        }



     /*   function SetPairColor(index) {
            "use strict";

            planeHolder.geometry.faces[index].color.set( LifeColor);
            planeHolder.geometry.faces[SisterIndex(index)].color.set( LifeColor);
            mesh.geometry.colorsNeedUpdate = true;
        }*/


        function SetPairColor(index, color) {
            "use strict";

            planeHolder.geometry.faces[index].color.set(color);
            planeHolder.geometry.faces[SisterIndex(index)].color.set(color);
            planeHolder.geometry.colorsNeedUpdate = true;
        }


        function CastRay() {
            "use strict";

            raycaster.setFromCamera(mouse, camera);
            var intersects = raycaster.intersectObject(plane);

            if ((intersects.length > 0) && (active == true)) {

                //Change triangle color
                //intersects[0].face.color;
                //Change sister triangle as well
                //intersects[0].face.color = LifeColor.clone();
                plane.geometry.faces[intersects[0].faceIndex].color.set(LifeColor);
                plane.geometry.faces[SisterIndex(intersects[0].faceIndex)].color.set(LifeColor);
                plane.geometry.colorsNeedUpdate = true;

            }
        }

        
        
        //Helper function
        function SisterIndex(index) {
            "use strict";
            if (isEven(index)) {
                return index + 1
            } else {
                return index - 1
            }
        }

        function isEven(value) {
            "use strict";
            if (value % 2 == 0)
                return true;
            else
                return false;
        }

        
        //Input Functions
        
        function onDocumentMouseMove(event) {
            "use strict";

            event.preventDefault();
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

        }

        function onDocumentMouseDown(event) {
            "use strict";

            event.preventDefault();
            document.addEventListener('mouseup', onDocumentMouseUp, false);
            active = true;

        }


        function onDocumentMouseUp(event) {
            "use strict";

            document.removeEventListener('mouseup', onDocumentMouseUp, false);
            active = false;
        }


        function inputKey(e) {
            "use strict";
            e = e || window.event;

            if (e.keyCode == '13') {
                //Enter
                if (enable == true) {
                    enable = false;
                } else {
                    enable = true;
                }
            }
        }
    </script>




    <!--   <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>-->
    <script>
        window.jQuery || document.write('<script src="js/vendor/jquery-1.11.2.min.js"><\/script>')
    </script>
    <script src="js/plugins.js"></script>
    <script src="js/main.js"></script>
</body>

</html>
